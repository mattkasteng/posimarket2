generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                    String                @id @default(cuid())
  email                 String                @unique
  senha                 String
  nome                  String
  cpf                   String                @unique
  telefone              String
  tipoUsuario           String
  enderecoId            String?
  escolaId              String?
  emailVerificado       Boolean               @default(false)
  suspenso              Boolean               @default(false)
  tokenVerificacao      String?
  tokenResetSenha       String?
  tokenResetExpiracao   DateTime?
  stripeCustomerId      String?
  stripeConnectId       String?
  pixKey                String?
  pixType               String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  mfaEnabled            Boolean               @default(false) @map("mfa_enabled")
  mfaSecret             String?               @map("mfa_secret")
  mfaBackupCodes        String?               @map("mfa_backup_codes")
  mfaEnabledAt          DateTime?             @map("mfa_enabled_at")
  mfaTempSecret         String?               @map("mfa_temp_secret")
  mfaTempBackupCodes    String?               @map("mfa_temp_backup_codes")
  mfaTempGeneratedAt    DateTime?             @map("mfa_temp_generated_at")
  api_keys              ApiKey[]
  avaliacoes            Avaliacao[]           @relation("Avaliador")
  enderecos             Endereco[]            @relation("EnderecosUsuario")
  mensagensRecebidas    Mensagem[]            @relation("Destinatario")
  mensagensEnviadas     Mensagem[]            @relation("Remetente")
  mfa_challenges        MfaChallenge[]
  pedidos               Pedido[]              @relation("Comprador")
  produtos              Produto[]             @relation("Vendedor")
  transacoesFinanceiras TransacaoFinanceira[]
  carrinho              Carrinho?
  endereco              Endereco?             @relation("EnderecoPrincipal", fields: [enderecoId], references: [id])
  escola                Escola?               @relation(fields: [escolaId], references: [id])
  conversasUsuario1     Conversa[]            @relation("ConversaUsuario1")
  conversasUsuario2     Conversa[]            @relation("ConversaUsuario2")

  @@map("usuarios")
}

model Escola {
  id         String    @id @default(cuid())
  nome       String
  cnpj       String    @unique
  enderecoId String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  produtos   Produto[]
  usuarios   Usuario[]

  @@map("escolas")
}

model Endereco {
  id               String    @id @default(cuid())
  cep              String
  logradouro       String
  numero           String
  complemento      String?
  bairro           String
  cidade           String
  estado           String
  pais             String    @default("Brasil")
  tipo             String
  padrao           Boolean   @default(false)
  usuarioId        String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  usuario          Usuario?  @relation("EnderecosUsuario", fields: [usuarioId], references: [id])
  usuarioPrincipal Usuario[] @relation("EnderecoPrincipal")

  @@map("enderecos")
}

model Produto {
  id                 String       @id @default(cuid())
  nome               String
  descricao          String
  preco              Float
  precoOriginal      Float?
  categoria          String
  condicao           String
  tamanho            String?
  cor                String?
  material           String?
  marca              String?
  modeloId           String?
  imagens            String
  vendedorId         String
  vendedorNome       String?
  escolaId           String?
  escolaNome         String?
  ativo              Boolean      @default(true)
  statusAprovacao    String       @default("PENDENTE")
  estoque            Int          @default(1)
  alertaEstoqueBaixo Int?         @default(3)
  desconto           Float?
  promocaoAtiva      Boolean      @default(false)
  mediaAvaliacao     Float?
  totalAvaliacoes    Int          @default(0)
  peso               Float?
  altura             Float?
  largura            Float?
  profundidade       Float?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  avaliacoes         Avaliacao[]
  itensPedido        ItemPedido[]
  escola             Escola?         @relation(fields: [escolaId], references: [id])
  vendedor           Usuario         @relation("Vendedor", fields: [vendedorId], references: [id])
  modelo             ModeloUniforme? @relation(fields: [modeloId], references: [id])
  conversas          Conversa[]
  itensCarrinho      ItemCarrinho[]

  @@map("produtos")
}

model Carrinho {
  id        String         @id @default(cuid())
  usuarioId String         @unique
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  usuario   Usuario        @relation(fields: [usuarioId], references: [id])
  itens     ItemCarrinho[]

  @@map("carrinhos")
}

model ItemCarrinho {
  id             String    @id @default(cuid())
  carrinhoId     String
  produtoId      String
  quantidade     Int       @default(1)
  reservadoDesde DateTime  @default(now())
  expiraEm       DateTime
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  carrinho       Carrinho  @relation(fields: [carrinhoId], references: [id])
  produto        Produto   @relation(fields: [produtoId], references: [id])

  @@unique([carrinhoId, produtoId])
  @@map("itens_carrinho")
}

model Pedido {
  id                 String       @id @default(cuid())
  numero             String       @unique
  compradorId        String
  status             String
  metodoPagamento    String
  valorTotal         Float
  valorSubtotal      Float
  taxaPlataforma     Float        @default(0)
  taxaHigienizacao   Float?
  custoEnvio         Float        @default(0)
  enderecoEntrega    String
  metodoEnvio        String       @default("PAC")
  transportadora     String?
  codigoRastreio     String?
  prazoEntrega       Int?
  pontoColeta        String?
  dataPedido         DateTime     @default(now())
  dataEntrega        DateTime?
  dataCancelamento   DateTime?
  motivoCancelamento String?
  observacoes        String?
  pedidoPaiId        String?
  vendedorId         String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  itens              ItemPedido[]
  pagamentos         Pagamento[]
  comprador          Usuario      @relation("Comprador", fields: [compradorId], references: [id])
  historico          HistoricoStatus[]

  @@map("pedidos")
}

model ItemPedido {
  id            String   @id @default(cuid())
  pedidoId      String
  produtoId     String
  quantidade    Int
  precoUnitario Float
  subtotal      Float
  createdAt     DateTime @default(now())
  pedido        Pedido   @relation(fields: [pedidoId], references: [id])
  produto       Produto  @relation(fields: [produtoId], references: [id])

  @@map("itens_pedido")
}

model Pagamento {
  id            String    @id @default(cuid())
  pedidoId      String
  valor         Float
  metodo        String
  status        String
  transacaoId   String?
  dataPagamento DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  pedido        Pedido    @relation(fields: [pedidoId], references: [id])

  @@map("pagamentos")
}

model HistoricoStatus {
  id          String   @id @default(cuid())
  pedidoId    String
  status      String
  observacao  String?
  createdAt   DateTime @default(now())
  pedido      Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)

  @@map("historico_status")
}

model Avaliacao {
  id          String   @id @default(cuid())
  produtoId   String
  avaliadorId String
  nota        Int
  comentario  String?
  createdAt   DateTime @default(now())
  avaliador   Usuario  @relation("Avaliador", fields: [avaliadorId], references: [id])
  produto     Produto  @relation(fields: [produtoId], references: [id])

  @@map("avaliacoes")
}

model Notificacao {
  id        String   @id @default(cuid())
  usuarioId String
  titulo    String
  mensagem  String
  tipo      String
  lida      Boolean  @default(false)
  link      String?
  data      DateTime @default(now())
  createdAt DateTime @default(now())

  @@map("notificacoes")
}

model Conversa {
  id         String     @id @default(cuid())
  produtoId  String
  usuario1Id String
  usuario2Id String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  mensagens  Mensagem[]
  produto    Produto    @relation(fields: [produtoId], references: [id])
  usuario1   Usuario    @relation("ConversaUsuario1", fields: [usuario1Id], references: [id])
  usuario2   Usuario    @relation("ConversaUsuario2", fields: [usuario2Id], references: [id])

  @@unique([produtoId, usuario1Id, usuario2Id])
  @@map("conversas")
}

model Mensagem {
  id                      String    @id @default(cuid())
  conversaId              String
  remetenteId             String
  destinatarioId          String
  texto                   String
  lida                    Boolean   @default(false)
  dataLeitura             DateTime?
  deletadoPorRemetente    Boolean   @default(false)
  deletadoPorDestinatario Boolean   @default(false)
  createdAt               DateTime  @default(now())
  conversa                Conversa  @relation(fields: [conversaId], references: [id], onDelete: Cascade)
  destinatario            Usuario   @relation("Destinatario", fields: [destinatarioId], references: [id])
  remetente               Usuario   @relation("Remetente", fields: [remetenteId], references: [id])

  @@map("mensagens")
}

model ModeloUniforme {
  id           String              @id @default(cuid())
  serie        String
  descricao    String
  tipo         String?
  cor          String?
  material     String?
  genero       String?
  fornecedorId Int?
  ativo        Boolean             @default(true)
  dataCadastro DateTime            @default(now())
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  fornecedor   FornecedorUniforme? @relation(fields: [fornecedorId], references: [id])
  produtos     Produto[]

  @@map("modelos_uniforme")
}

model TamanhoUniforme {
  id           String   @id @default(cuid())
  tamanho      String
  alturaMin    Int?
  alturaMax    Int?
  pesoMin      Float?
  pesoMax      Float?
  peitoMin     Int?
  peitoMax     Int?
  ordem        Int      @default(0)
  dataCadastro DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("tamanhos_uniforme")
}

model FornecedorUniforme {
  id           Int              @id @default(autoincrement())
  nome         String
  email        String?
  telefone     String?
  endereco     String?
  status       String           @default("PENDENTE")
  dataCadastro DateTime         @default(now())
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  modelos      ModeloUniforme[]

  @@map("fornecedores_uniforme")
}

model TransacaoFinanceira {
  id            String   @id @default(cuid())
  vendedorId    String
  tipo          String
  valor         Float
  status        String   @default("PENDENTE")
  descricao     String?
  dataTransacao DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  vendedor      Usuario  @relation(fields: [vendedorId], references: [id], onDelete: Cascade)

  @@map("transacoes_financeiras")
}

model ApiKey {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  nome       String
  descricao  String?
  hashedKey  String    @map("hashed_key")
  lastUsedAt DateTime? @map("last_used_at")
  expiresAt  DateTime? @map("expires_at")
  revokedAt  DateTime? @map("revoked_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @default(now()) @map("updated_at")
  usuarios   Usuario   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([userId])
  @@map("api_keys")
}

model MfaChallenge {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  attempts  Int      @default(0)
  consumed  Boolean  @default(false)
  usuarios  Usuario  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([userId])
  @@map("mfa_challenges")
}
